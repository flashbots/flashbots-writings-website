<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Flashbots Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Flashbots Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><title data-react-helmet="true">Backrunning Private Transactions Using Multi-Party Computation | Flashbots</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://writings.flashbots.net/backrunning-private-txs-MPC"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Backrunning Private Transactions Using Multi-Party Computation | Flashbots"><meta data-react-helmet="true" name="description" content="This article examines the use of secure multi-party computation in allowing searchers to backrun users‚Äô transactions while preserving transaction and search strategy confidentiality."><meta data-react-helmet="true" property="og:description" content="This article examines the use of secure multi-party computation in allowing searchers to backrun users‚Äô transactions while preserving transaction and search strategy confidentiality."><meta data-react-helmet="true" property="og:image" content="https://writings.flashbots.net/img/posts/backrunning-MPC/header.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://writings.flashbots.net/img/posts/backrunning-MPC/header.jpg"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2023-02-27T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://annessi.net/"><meta data-react-helmet="true" property="article:tag" content="research"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://writings.flashbots.net/backrunning-private-txs-MPC"><link data-react-helmet="true" rel="alternate" href="https://writings.flashbots.net/backrunning-private-txs-MPC" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://writings.flashbots.net/backrunning-private-txs-MPC" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.493ced36.css">
<link rel="preload" href="/assets/js/runtime~main.a693e036.js" as="script">
<link rel="preload" href="/assets/js/main.06935cd7.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navRoot_LKda navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items fixFlex_OJh4"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><svg width="12" height="14" viewBox="0 0 12 14"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.07289 0L7.91879 0.483459L6.631 4.76674H11.5178L4.19989 12.679L3.35398 12.1956L4.72089 7.64736H0L7.07289 0ZM5.20514 6.03608L6.33835 2.26697L2.28701 6.64736H5.02136L5.20514 6.03608ZM4.93407 10.4124L9.23077 5.76674H6.33078L6.16271 6.3243L4.93407 10.4124Z" fill="var(--ifm-font-color-base)"></path></svg><span class="navbar__title title_WuSz logoTitle_PCW0">Flashbots</span></a></div><div class="navbar__items navbar__items--right fixFlex_OJh4 navItems_TfOx"><a href="https://flashbots.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>About</span></a><a href="https://boost.flashbots.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>MEV-Boost</span></a><a href="https://collective.flashbots.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Forum</span></a><a href="https://jobs.flashbots.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Join us</span></a><div class="react-toggle toggle_F2cT react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page layoutDefaults_XzHD"><div class="container margin-vert--md containerRoot_MxZn"><div class="row"><main class="col col--12" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_RC3s" itemprop="headline">Backrunning Private Transactions Using Multi-Party Computation</h1><div class="blogPostData_A2Le margin-vert--md"><time datetime="2023-02-27T00:00:00.000Z" itemprop="datePublished">27.02.23</time> ¬∑ 25 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_WtYC"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://annessi.net/" target="_blank" rel="noopener noreferrer" class="fixedColor_BDNu" itemprop="url"><span itemprop="name">Robert Annessi</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://writings.flashbots.net/img/posts/backrunning-MPC/header.jpg"><div class="markdown" itemprop="articleBody"><p>This article examines the use of secure multi-party computation in allowing searchers to backrun users‚Äô transactions while preserving transaction and search strategy confidentiality.</p><p><em>Thanks to <a href="https://twitter.com/fiiiu_" target="_blank" rel="noopener noreferrer">Alejo Salles</a>, <a href="https://jopasser.at/" target="_blank" rel="noopener noreferrer">Jonathan Passerat-Palmbach</a>, <a href="https://twitter.com/mmrosum" target="_blank" rel="noopener noreferrer">Mateusz Morusiewicz</a>, <a href="https://twitter.com/0xQuintus" target="_blank" rel="noopener noreferrer">Quintus Kilbourn</a>, <a href="https://twitter.com/obadiaalex" target="_blank" rel="noopener noreferrer">Alex Obadia</a>, <a href="https://twitter.com/metachris" target="_blank" rel="noopener noreferrer">Chris Hager</a>, <a href="https://collective.flashbots.net/u/chayoterabit/" target="_blank" rel="noopener noreferrer">Leonardo Arias</a>, and <a href="https://twitter.com/hasufl" target="_blank" rel="noopener noreferrer">Hasu</a> for feedback and discussions.</em> üôè</p><div style="text-align:center;margin-top:60px"><img src="/img/posts/backrunning-MPC/header.jpg"></div><p>Please find the proof-of-concept code for backrunning private transaction using MPC on <a href="https://github.com/flashbots/mpc-backrun" target="_blank" rel="noopener noreferrer">GitHub</a>. Join us in <a href="https://collective.flashbots.net/t/backrunning-private-transactions/1198" target="_blank" rel="noopener noreferrer">the forum, to discuss, and collaborate</a>. There is also a <a href="https://www.youtube.com/watch?v=3vzOXOUMLpo" target="_blank" rel="noopener noreferrer">20-minutes presentation</a>, in case you prefer watching a presentation instead of or in addition to reading this article.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h2><p>Blockchains operate through the creation of blocks, which are published by proposers and consist of a list of user-generated transactions that are executed in order. However, the ability of proposers to alter the order of transactions and censor certain transactions has led to the rise of an MEV extraction industry. In this industry, users bleed money to searchers, builders, and proposers who specialize in extracting value, building profitable blocks, and earning fees for block inclusion. While some forms of MEV are widely seen as harmful to users, there is no widespread agreement on how to address it. Some efforts aim to mitigate MEV by using transaction ordering protocols or private mempools with threshold cryptography, for example, while others aim to reshape the value extraction industry such that it benefits users. The approach discussed in this article belongs to the latter category.</p><p align="center"><img src="/img/posts/backrunning-MPC/tx_supply_chain.jpg" alt="Illustration of the End-to-End Transaction Supply Chain"></p><p align="center"><sup>Illustration of the End-to-End Transaction Supply Chain</sup></p><p>When examining the entire MEV transaction supply chain from user to proposer, it becomes clear that solving MEV in this model - where nobody gets any feedback until the block lands on chain - at once is overly complicated. In this article, we focus on the user-searcher interface, where the user wants to keep their transaction confidential from the searcher and also the searcher wants to keep their search strategy confidential from the user as well as the builder. The approach described in this article allows for both front-running and backrunning of transactions. While front-running and some other forms of value extraction are considered harmful to users, backrunning allows for efficient arbitrage and liquidations without impacting users since their transaction have already been completed. However, searchers competing over backrunning opportunities in the public mempool have led to negative side effects, such as bidding up transaction fees and making transactions more expensive for all users. Therefore, there is a need for a solution that allows searchers to backrun users&#x27; transactions without negatively affecting everyone, with privacy being the core of such a solution.</p><p>In order to make the problem more tangible, we simplify it further by considering a scenario with only one user and one searcher, who send the backrun transaction to a single builder who is trusted to not extract value from the user&#x27;s transaction and to include both the user&#x27;s transaction and the searcher&#x27;s signed backrun transaction in the same block.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="sgx-based-backrunning-and-covert-channels"></a>SGX-Based Backrunning and Covert Channels<a class="hash-link" href="#sgx-based-backrunning-and-covert-channels" title="Direct link to heading">#</a></h2><p>Given this private computation setting, Trusted Execution Environments (TEEs) such as Intel‚Äôs Software Guard Extensions (SGX) come to mind as a reasonable solution. The purpose of Intel‚Äôs SGX is to provide secure remote computation, meaning that the correctness of an output of a trusted program can be assured even if it was executed on an untrusted machine.</p><p align="center"><img src="/img/posts/backrunning-MPC/sgx.jpg" alt="SGX-based Backrunning Private Transactions"></p><p align="center"><sup>SGX-based Backrunning Private Transactions</sup></p><p>An SGX-based solution for backrunning private transactions could involve the following steps:</p><ol><li>The user submits a transaction to the backrunning program, which operates within an SGX enclave on the searcher&#x27;s machine.</li><li>The searcher provides a search program and a secret key to the backrunning program.</li><li>The backrunning program is executed within the SGX enclave and uses the search program to generate a backrun transaction from the user&#x27;s transaction.</li><li>The backrun transaction is then signed with the secret key provided by the searcher.</li><li>Finally, both the user&#x27;s transaction and the signed backrun transaction are sent to the builder.</li></ol><p>It&#x27;s important to note that all communication between the SGX backrunning program and all entities can be transport-layer encrypted.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><pre tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">backrun_tx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SEARCH_PROGRAM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">USER_TX</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">signature </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sign</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">backrun_tx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SECRET_KEY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">sendToBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">USER_TX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> backrun_tx </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> signature</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>However, there is an issue: <strong>covert channels</strong>. Covert channels are a method of secretly conveying information by piggybacking on existing overt channels that are misused to exfiltrate information. Another way to think of covert channels is as a way of secretly modulating information on an existing carrier signal. Covert channels differ from side channels in that a side channel attack allows an attacker to observe the system only from the outside, while a covert channel attack allows an attacker to get support from inside the system. The concern is that (untrusted) inputs can potentially alter program execution in such a way that secret information is leaked through covert channels. In the case at hand, the searcher program may be used to alter the execution of the SGX backrunning program such that the user&#x27;s transaction is revealed. To prevent this, it&#x27;s crucial to examine the specific overt channels in place.</p><table><thead><tr><th>Existing Overt Channel</th><th>Countermeasure</th></tr></thead><tbody><tr><td>Enclave‚Äôs output, i.e., a bundle</td><td>‚úî Encryption</td></tr><tr><td>Network communication</td><td>‚úî Restrict network communication from within the enclave.</td></tr><tr><td>CPU and memory of the host system</td><td>‚Åá</td></tr></tbody></table><p>Since the user‚Äôs transaction is already part of the enclave‚Äôs output, the output has to be (transport-)encrypted. Otherwise, the searcher could just observe the output and learn the user‚Äôs transaction this way. Another way to exfiltrate information is through network communication, which must be restricted to avoid this information leakage. This means that connecting to the Ethereum P2P network is not possible, as each connection and each query can be used to exfiltrate information. Two other overt channels to consider are the CPU and memory of the host system. For example, a covert channel could encode information through the CPU by using high or low CPU usage to represent binary values. Another covert channel could encode information through the allocation of memory pages or patterns of memory access.</p><p>To ensure the user&#x27;s transaction remains confidential, the searcher&#x27;s input must not be able to alter program execution in a way that reveals the transaction through covert channels. Restricting the expressiveness of the searcher&#x27;s input seems to be a prerequisite, but this may not be desirable for the searcher. For this reason, there exists a trade-off between the expressiveness of the searcher&#x27;s program and the potential for covert channels. It can be challenging to determine the right balance and starting point, as the design space is vast. One approach could be to start fully expressive and gradually restrict the expressiveness until the amount of leaked data is deemed reasonable, but it may be difficult to determine this with certainty. Another approach could be to start fully restricted and gradually loosen restrictions until the searcher&#x27;s program is expressive enough, but it&#x27;s unclear how to determine when this has been achieved. Alternatively, starting somewhere in the middle of the expressiveness-covert channels trade-off space may be a blind approach.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="mpc-based-backrunning"></a>MPC-Based Backrunning<a class="hash-link" href="#mpc-based-backrunning" title="Direct link to heading">#</a></h2><p>To explore the design space of search program‚Äôs expressiveness, without leaking information through covert channels, we use <a href="https://dl.acm.org/doi/10.1145/3387108" target="_blank" rel="noopener noreferrer">secure multiparty computation (MPC)</a>. MPC enables multiple parties to jointly compute a public function while keeping their inputs confidential, ensuring that only the output of the function is revealed. One commonly used technique for achieving this is Shamir secret sharing, where inputs are divided into shares, distributed among the parties, and computations on the shares are performed without revealing the actual input values.</p><p align="center"><img src="/img/posts/backrunning-MPC/mpc.jpg" alt="MPC-based Backrunning Private Transactions"></p><p align="center"><sup>MPC-based Backrunning Private Transactions</sup></p><p>In our design, we use MPC to ensure that the builder, who is trusted not to extract value, is the only party receiving the user transaction and signed backrun transaction output, thereby eliminating the potential for covert channel exploitation. The MPC setting is similar to that of SGX, but with two key differences. First, the backrunning program is executed as a communication protocol between the user and the searcher, rather than as a program within an SGX enclave on the searcher&#x27;s machine. Second, confidentiality is ensured through MPC instead of SGX.</p><p>By using MPC, we can explore the design space of the search program&#x27;s design space securely, without the risk of information leakage through covert channels. The inputs to the function are kept confidential through the use of cryptographic techniques, ensuring that only the output of the function is revealed. We experimented with <a href="https://github.com/data61/MP-SPDZ" target="_blank" rel="noopener noreferrer">MP-SPDZ</a>, a general MPC framework, to design the searcher language and the backrunning protocol.</p><p>It&#x27;s important to stress that our goal at this point is to open the space for exploration and not create a practical solution. To this end, we rely on abstract concepts such as MPC, which can be implemented using various techniques like Shamir secret sharing, to achieve confidentiality and security in the design process.</p><p>The user inputs a complete transaction into the MPC backrunning protocol, while the searcher inputs a searcher program that represents their strategy, as well as a secret key to sign the backrunning transaction. The MPC backrunning protocol then creates a backrunning transaction based on these inputs. The searcher program consists of four parts, which are executed in that order:</p><ol><li>A list of constants.</li><li>A list of basic computing instructions, formatted as <code>&lt;operand1_location&gt;</code> <code>&lt;operator&gt;</code> <code>&lt;operand2_location&gt;</code>, where the location refers to the location of the operand in the protocol&#x27;s internal storage. The storage is populated with data from the RLP-decoded user&#x27;s transaction and searcher-provided constants. The result of a computation is appended to the protocol‚Äôs internal storage, which allows operations to use results from previous computations. The PoC supports basic arithmetic operations such as addition, subtraction, multiplication, division, and square root. Loops with a length dependent on secret information are not permitted, as they would lead to information leakage. Fixed-length loops, yet, can be supported by unrolling the loop.</li><li>A set of basic comparison instructions in the format of <code>&lt;comperand1_location&gt;</code> <code>&lt;comperator&gt;</code> <code>&lt;comperand2_location&gt;</code>. The location refers to a location of the comperand in the protocol&#x27;s internal storage. The PoC currently supports the following comparisons: less than, less than or equal, greater than, greater than or equal, equal, and not equal.</li><li>A list of references to populate the backrunning transaction. The first item refers to the protocol-internal storage location of the nonce, the second item refers to the storage location of the gas limit, the third to the gas price, and so forth.</li></ol><p>Now that we described the searcher language, which defines the structure of a search program, let&#x27;s examine the design of the MPC backrunning protocol:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><pre tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># protocol-internal storage</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># RLP-decode the user&#x27;s transaction and append to storage</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RLPDecode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TX</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># append searcher-provided constants to storage</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SEARCHER_PROGRAM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">constants</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># execute searcher-provided computations on storage</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> p </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> SEARCHER_PROGRAM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">computations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> storage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># perform searcher-provided comparisons on storage and track whether all returned True</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> c </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> SEARCHER_PROGRAM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">comparisons</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        success </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> perform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> storage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># create backrunning transaction</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">backrun_tx_unsigned </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RLPEncode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">propagateTx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SEARCHER_PROGRAM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">references</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> storage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># sign backrunning transaction</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">backrun_tx_signed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sign</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">backrun_tx_unsigned</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SECRET_KEY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># send user transaction and signed backrunning (or empty) transaction to builder</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> success</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        sendToBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> backrun_tx_signed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        sendToBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="proof-of-concept-walk-through"></a>Proof-of-Concept Walk-Through<a class="hash-link" href="#proof-of-concept-walk-through" title="Direct link to heading">#</a></h2><p>This section goes into the technical details of the implementation. While not required to understand the high-level design, it may still be of interest for those who want to gain a deeper understanding. If you prefer to just get a general idea, feel free to skim this section and proceed to the open questions and conclusion of this article. For those who would like to see the specifics, we&#x27;ve included a step-by-step example. The proof of concept was implemented using <a href="https://github.com/data61/MP-SPDZ" target="_blank" rel="noopener noreferrer">MP-SPDZ</a>, which has a syntax similar to Python. The code and instructions on how to set up and run the code can be found on <a href="https://github.com/flashbots/mpc-backrun" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><p>The PoC code has the following limitations:</p><ul><li>Signature generation for the backrunning transaction is not included in this PoC. Although the implementation of signature generation would be beneficial for the PoC, it is not considered the highest priority in light of the goal to explore the trade-off between the expressiveness of the searcher‚Äôs program and the potential for covert channels.</li><li>The originator of the transaction is not extracted, which could be used for searching and for paying rewards.</li></ul><p>To demonstrate the PoC, we use a real-world transaction from December 2022 in which 3.75 ETH were exchanged for 4,784.912579 USDT on Uniswap V2: <a href="https://etherscan.io/tx/0xe31ba3d6c9a0a87730a6d49565f7d445aa7240ae823758ee74f4d4f76fdc9f28" target="_blank" rel="noopener noreferrer">https://etherscan.io/tx/0xe31ba3d6c9a0a87730a6d49565f7d445aa7240ae823758ee74f4d4f76fdc9f28</a>.</p><p>The MPC backrunning protocol consists of the following steps:</p><ol><li>Decode the user&#x27;s transaction using RLP and populate the protocol-internal storage.</li><li>Load constants from the searcher program and add them to the storage.</li><li>Execute computations from the searcher program.</li><li>Perform comparisons from the searcher program.</li><li>Create the backrunning transaction.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="decoding-the-transaction-with-rlp"></a>Decoding the Transaction with RLP<a class="hash-link" href="#decoding-the-transaction-with-rlp" title="Direct link to heading">#</a></h3><p>The protocol begins by decoding the raw user transaction and populating the storage. The internal storage then looks like this:</p><table><thead><tr><th>Storage Slot</th><th>Value</th><th>Comment</th></tr></thead><tbody><tr><td>0</td><td>3</td><td>Nonce</td></tr><tr><td>1</td><td>12000000000</td><td>Gas Limit</td></tr><tr><td>2</td><td>187657</td><td>Gas Price</td></tr><tr><td>3</td><td>0x7a250d5630b4cf539739df2c5dacb4c659f2488d</td><td>To-Address</td></tr><tr><td>4</td><td>3750000000000000000</td><td>Value</td></tr><tr><td>5</td><td>0x7ff36ab5</td><td>Data: Function Selector</td></tr><tr><td>6</td><td>4761107043</td><td>Data: amountOutMin</td></tr><tr><td>7</td><td>128</td><td>Data: address[] Offset</td></tr><tr><td>8</td><td>0xb3d8374bda9b975beefde96498fd371b484bdc0d</td><td>Data: To-Address</td></tr><tr><td>9</td><td>1669877861</td><td>Data: Deadline</td></tr><tr><td>10</td><td>2</td><td>Data: address[] Length</td></tr><tr><td>11</td><td>0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2</td><td>Data: Token1</td></tr><tr><td>12</td><td>0xdac17f958d2ee523a2206206994597c13d831ec7</td><td>Data: Token2</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="loading-constants"></a>Loading Constants<a class="hash-link" href="#loading-constants" title="Direct link to heading">#</a></h3><p>The next step involves loading the constants from the search program. It&#x27;s important to note that some provided constants represent on-chain information, such as the number of tokens in the ETH/USDT pool at block 16088213. This eliminates the need for the protocol to query the EVM state. However, it is the responsibility of the searcher to keep these constants updated as the EVM state changes.</p><table><thead><tr><th>Comparison Data</th><th>Comments</th></tr></thead><tbody><tr><td>0x7a250d5630b4cf539739df2c5dacb4c659f2488d</td><td>Uniswap v2 Router Address</td></tr><tr><td>0x7ff36ab5</td><td>Function Selector swapExactETHForTokens(uint256,address[],address,uint256)</td></tr><tr><td>2</td><td>Path Length</td></tr><tr><td>0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2</td><td>WETH Token Address</td></tr><tr><td>0xdac17f958d2ee523a2206206994597c13d831ec7</td><td>USDT Token Address</td></tr><tr><td>1669870000</td><td>Minimum Deadline</td></tr><tr><td></td><td></td></tr><tr><td>Constants for Backrunning Amount &amp; Profit</td><td></td></tr><tr><td>3</td><td>0.3% Fixed Uniswap v2 Fee Dividend</td></tr><tr><td>1000</td><td>0.3% Fixed Uniswap v2 Fee Divisor</td></tr><tr><td>11866579405959229103761</td><td>WETH in the Pool (at Block 16088213): 11866.579405959229103761</td></tr><tr><td>15191824718342</td><td>USDT in the Pool (at Block 16088213): 15191824.718342</td></tr><tr><td>1000000000000000000</td><td>WETH Precision</td></tr><tr><td>2</td><td>Constant for Computing amountIn (Backrunning)</td></tr><tr><td>1283500000</td><td>Maximum Buy Price (ETH/USDT Target Price for Backrun): 1283.5 USDT</td></tr><tr><td>4</td><td>Constant for Computing amountIn (Backrunning)</td></tr><tr><td>1286000000</td><td>Minimum Sell Price (ETH/USDT Target Price for Backrun): 1286.0 USDT</td></tr><tr><td>2000000</td><td>Cost of Arbitrage Execution: 2.0 USDT</td></tr><tr><td>0</td><td>Minimum Amount and Profit Requirements</td></tr><tr><td></td><td></td></tr><tr><td>Backrunning Transaction Data</td><td></td></tr><tr><td>101</td><td>Backrunning Transaction Nonce</td></tr><tr><td>12000000000</td><td>Gas Limit</td></tr><tr><td>187788</td><td>Gas Price</td></tr><tr><td>0x18cbafe5</td><td>Function Selector: swapExactTokensForETH(uint256,uint256,address[],address,uint256)</td></tr><tr><td>160</td><td>address[] Data Offset</td></tr><tr><td>0x4eed8f7a1df19a7fb7cc99b18909d99d065544b2</td><td>ETH Recipient</td></tr><tr><td>1669877869</td><td>Deadline</td></tr></tbody></table><p>The necessary constant values have been added to the protocol-internal storage.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="execute-computations"></a>Execute Computations<a class="hash-link" href="#execute-computations" title="Direct link to heading">#</a></h3><p>Before delving into the computations executed in the search strategy, let&#x27;s clarify what the searcher aims to achieve and how the Uniswap v2 pricing function works. Uniswap v2 defines the price of an asset as the ratio of the number of tokens of the corresponding assets in the pool, X and Y, i.e., USDT and WETH. However, users do not get this price exactly, as they also incur a fixed fee of 0.3% when buying or selling an asset. This fee causes users to pay a slightly higher price when buying an asset and receive a slightly lower price when selling an asset. By trading, the number of tokens in the pool changes, and therefore, the price changes as well. To calculate the new number of tokens in the pool, we use the following formulas: <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mtext>after</mtext></msub><mo>=</mo><mi>X</mi><mo>+</mo><mtext>amount</mtext></mrow><annotation encoding="application/x-tex">X_\text{after} = X + \text{amount}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord text mtight"><span class="mord mtight">after</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em"></span><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em"></span><span class="mord text"><span class="mord">amount</span></span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mtext>after</mtext></msub><mo>=</mo><mfrac><mrow><mi>X</mi><mo>‚ãÖ</mo><mi>Y</mi></mrow><mrow><mi>X</mi><mo>+</mo><mtext>amount</mtext><mo>‚ãÖ</mo><mo stretchy="false">(</mo><mn>1</mn><mo>‚àí</mo><mtext>FEE</mtext><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">Y_\text{after} = \frac{X \cdot Y}{X + \text{amount} \cdot (1 - \text{FEE})}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord text mtight"><span class="mord mtight">after</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.392331em;vertical-align:-0.52em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em">X</span><span class="mbin mtight">+</span><span class="mord text mtight"><span class="mord mtight">amount</span></span><span class="mbin mtight">‚ãÖ</span><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">‚àí</span><span class="mord text mtight"><span class="mord mtight">FEE</span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em">X</span><span class="mbin mtight">‚ãÖ</span><span class="mord mathnormal mtight" style="margin-right:0.22222em">Y</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>. Here, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>amount</mtext></mrow><annotation encoding="application/x-tex">\text{amount}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em"></span><span class="mord text"><span class="mord">amount</span></span></span></span></span></span> represents the number of <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.07847em">X</span></span></span></span></span> tokens that are sold for <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.22222em">Y</span></span></span></span></span> tokens. After the trade, the user receives <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>‚àí</mo><msub><mi>Y</mi><mtext>after</mtext></msub></mrow><annotation encoding="application/x-tex">Y - Y_\text{after}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em"></span><span class="mord mathnormal" style="margin-right:0.22222em">Y</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">‚àí</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord text mtight"><span class="mord mtight">after</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> tokens of the <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.22222em">Y</span></span></span></span></span> asset. We can compute the price after the trade as</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mstyle mathsize="0.9em"><mtext>price</mtext><mo>=</mo><mfrac><mrow><mi>X</mi><mo>‚ãÖ</mo><mi>Y</mi></mrow><mrow><mi>X</mi><mo>+</mo><mtext>amount</mtext><mo>‚ãÖ</mo><mo stretchy="false">(</mo><mn>1</mn><mo>‚àí</mo><mtext>FEE</mtext><mo stretchy="false">)</mo></mrow></mfrac><mo>:</mo><mo stretchy="false">(</mo><mi>X</mi><mo>+</mo><mtext>amount</mtext><mo stretchy="false">)</mo></mstyle></mrow><annotation encoding="application/x-tex">\small \text{price} = \frac{X \cdot Y}{X + \text{amount} \cdot (1 - \text{FEE})} : (X + \text{amount})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77607em;vertical-align:-0.174996em"></span><span class="mord text sizing reset-size6 size5"><span class="mord">price</span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel sizing reset-size6 size5">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.066697em;vertical-align:-0.8424em"></span><span class="mord sizing reset-size6 size5"><span class="mopen nulldelimiter sizing reset-size5 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord text"><span class="mord">amount</span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">‚àí</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord text"><span class="mord">FEE</span></span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord mathnormal" style="margin-right:0.22222em">Y</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size5 size6"></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel sizing reset-size6 size5">:</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.9em;vertical-align:-0.225em"></span><span class="mopen sizing reset-size6 size5">(</span><span class="mord mathnormal sizing reset-size6 size5" style="margin-right:0.07847em">X</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin sizing reset-size6 size5">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.9em;vertical-align:-0.225em"></span><span class="mord text sizing reset-size6 size5"><span class="mord">amount</span></span><span class="mclose sizing reset-size6 size5">)</span></span></span></span></span></div><p>If we transform this equation to be expressed in the amount of tokens to be sold, and account for the difference in precision between USDT and WETH, we get:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mstyle mathsize="0.8em"><mtext>amount</mtext><mo>=</mo><mfrac><mrow><msqrt><mrow><mtext>PREC</mtext><mo>‚ãÖ</mo><mi>X</mi><mo>‚ãÖ</mo><mo stretchy="false">(</mo><msup><mtext>FEE</mtext><mn>2</mn></msup><mo>‚ãÖ</mo><mtext>PREC</mtext><mo>‚ãÖ</mo><mi>X</mi><mo>+</mo><mn>4</mn><mo>‚ãÖ</mo><mtext>PRICE</mtext><mo>‚ãÖ</mo><mi>Y</mi><mo>‚ãÖ</mo><mo stretchy="false">(</mo><mn>1</mn><mo>‚àí</mo><mtext>FEE</mtext><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></msqrt><mo>+</mo><mtext>PREC</mtext><mo>‚ãÖ</mo><mi>X</mi><mo>‚ãÖ</mo><mo stretchy="false">(</mo><mtext>FEE</mtext><mo>‚àí</mo><mn>2</mn><mo stretchy="false">)</mo></mrow><mrow><mn>2</mn><mo>‚ãÖ</mo><mtext>PREC</mtext><mo>‚ãÖ</mo><mo stretchy="false">(</mo><mn>1</mn><mo>‚àí</mo><mtext>FEE</mtext><mo stretchy="false">)</mo></mrow></mfrac></mstyle></mrow><annotation encoding="application/x-tex">\footnotesize \text{amount} = \frac{\sqrt{\text{PREC} \cdot X \cdot (\text{FEE}^2 \cdot \text{PREC} \cdot X + 4 \cdot \text{PRICE} \cdot Y \cdot (1 - \text{FEE}))} + \text{PREC} \cdot X \cdot (\text{FEE} - 2)}{2 \cdot \text{PREC} \cdot (1 -\text{FEE})}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.492064em;vertical-align:0em"></span><span class="mord text sizing reset-size6 size4"><span class="mord">amount</span></span><span class="mspace" style="margin-right:0.3252777777777778em"></span><span class="mrel sizing reset-size6 size4">=</span><span class="mspace" style="margin-right:0.3252777777777778em"></span></span><span class="base"><span class="strut" style="height:2.158164em;vertical-align:-0.8016000000000001em"></span><span class="mord sizing reset-size6 size4"><span class="mopen nulldelimiter sizing reset-size4 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.695705em"><span style="top:-2.248em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord text"><span class="mord">PREC</span></span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚àí</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord text"><span class="mord">FEE</span></span><span class="mclose">)</span></span></span><span style="top:-3.2255000000000003em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.049em"></span></span><span style="top:-3.732em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.963705em"><span class="svg-align" style="top:-3.2em"><span class="pstrut" style="height:3.2em"></span><span class="mord" style="padding-left:1em"><span class="mord text"><span class="mord">PREC</span></span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">FEE</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.79616em"><span style="top:-2.91283em;margin-right:0.0625em"><span class="pstrut" style="height:2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord text"><span class="mord">PREC</span></span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord text"><span class="mord">PRICE</span></span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord mathnormal" style="margin-right:0.22222em">Y</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚àí</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord text"><span class="mord">FEE</span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:-2.923705em"><span class="pstrut" style="height:3.2em"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em"><svg width="400em" height="1.28em" viewBox="0 0 400000 1296" preserveAspectRatio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.27629499999999996em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord text"><span class="mord">PREC</span></span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mopen">(</span><span class="mord text"><span class="mord">FEE</span></span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mbin">‚àí</span><span class="mspace" style="margin-right:0.26022222222222224em"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:1.002em"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size4 size6"></span></span></span></span></span></span></div><p>So, why would the searcher need this equation? Suppose the price in the Uniswap v2 pool is changed by a trade in a way that makes it now profitable to arbitrage against another exchange, such as a centralized exchange (CEX). In that case, the searcher can use that formula to determine the amount of (USDT) tokens to sell to receive the maximum number of (ETH) tokens up to the target price. This is precisely what the formula accomplishes.</p><p>To execute a backrun of a swap of ETH for USDT on Uniswap v2, the searcher&#x27;s strategy should consider the market price on the CEX, the pricing function of Uniswap v2, and the state of the Uniswap v2 pool. In this way, the searcher can determine the amount of tokens they can buy up to a specific target price and calculate their profit. To compute the amount of USDT tokens to sell in the backrunning transaction, the searcher applies the previous formula, where X and Y are computed from the amount of WETH and USDT in the Uniswap v2 pool before and after the user&#x27;s trade. The constants FEE, PRICE, and PRECISION are provided by the searcher.</p><table><thead><tr><th>Variable</th><th>Comment</th><th>Formula</th></tr></thead><tbody><tr><td>X</td><td>The amount of USDT in the Uniswap v2 pool after the user‚Äôs trade.</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>=</mo><mfrac><mrow><msub><mtext>ETH</mtext><mtext>before</mtext></msub><mo>‚ãÖ</mo><msub><mtext>USDT</mtext><mtext>before</mtext></msub></mrow><mi>Y</mi></mfrac></mrow><annotation encoding="application/x-tex">X = \frac{\text{ETH}_\text{before} \cdot \text{USDT}_\text{before}}{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.239191em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.894191em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em">Y</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.41586em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ETH</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3487714285714287em;margin-right:0.07142857142857144em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord text mtight"><span class="mord mtight">before</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em"><span></span></span></span></span></span></span><span class="mbin mtight">‚ãÖ</span><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">USDT</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3487714285714287em;margin-right:0.07142857142857144em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord text mtight"><span class="mord mtight">before</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></td></tr><tr><td>Y</td><td>The amount of ETH in the Uniswap v2 pool after the user‚Äôs trade.</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><msub><mtext>ETH</mtext><mtext>before</mtext></msub><mo>+</mo><mtext>amount</mtext><mo>‚ãÖ</mo><mo stretchy="false">(</mo><mn>1</mn><mo>‚àí</mo><mtext>FEE</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Y = \text{ETH}_\text{before} + \text{amount} \cdot (1 - \text{FEE})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.22222em">Y</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord text"><span class="mord">ETH</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em"><span style="top:-2.5500000000000003em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord text mtight"><span class="mord mtight">before</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em"></span><span class="mord text"><span class="mord">amount</span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">‚àí</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord text"><span class="mord">FEE</span></span><span class="mclose">)</span></span></span></span></span></td></tr><tr><td>FEE</td><td>The fee for trading in Uniswap v2.</td><td>searcher-provided constant</td></tr><tr><td>PRICE</td><td>The price up to which to buy the asset.</td><td>searcher-provided constant</td></tr><tr><td>PREC</td><td>The number of decimals for WETH.</td><td>searcher-provided constant</td></tr></tbody></table><p>The profit is calculated as <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>profit</mtext><mo>=</mo><mo stretchy="false">(</mo><mtext>sell¬†price</mtext><mo>‚àí</mo><mtext>buy¬†price</mtext><mo stretchy="false">)</mo><mo>‚ãÖ</mo><mtext>amountOut</mtext><mo>‚àí</mo><mtext>cost</mtext></mrow><annotation encoding="application/x-tex">\text{profit} = (\text{sell price} - \text{buy price}) \cdot \text{amountOut} - \text{cost}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em"></span><span class="mord text"><span class="mord">profit</span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord text"><span class="mord">sell¬†price</span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">‚àí</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord text"><span class="mord">buy¬†price</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em"></span><span class="mord text"><span class="mord">amountOut</span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">‚àí</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em"></span><span class="mord text"><span class="mord">cost</span></span></span></span></span></span>, where <em>sell price</em> is the lower bound of the price at which the searcher can sell ETH at the CEX, <em>buy price</em> is the price up to which the searcher buys ETH for USDT on Uniswap v2, <em>amountOut</em> is the amount of ETH received from the backrunning transaction on Uniswap v2, and <em>cost</em> is the cost of executing both the on-chain transaction and the trade on the CEX. Although the formulas may appear daunting at first, the complexity mainly stems from understanding how the pricing function in Uniswap v2 affects the calculation of a backrunning transaction. All computations required are basic arithmetic operations (plus the square root function), and all necessary information is provided upfront or can be derived from the user transaction and searcher-provided constants. The computations are expressed in low-level code, with no variables, loops, nor branching, but only references to storage locations and operators. The operator codes are 0 for addition, 1 for subtraction, 2 for multiplication, 3 for division, and 4 for square root. Since MPC works on integers, operator names are considered part of a high-level language in future work.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><pre tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># note that the fee in Uniswap is calculated as if it was taken from amountIn (although it is actually deducted from amountOut)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># amount paid to uniswap for fees = amountIn * fee = 3750000000000000000 * 3 / 1000</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">53</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># division for the above</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">54</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># amountIn_fees = amountIn - fees</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">31</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">55</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># WETH in the pool after the swap (just for fee calculation - not for real) = WETH_before + amountIn_fees</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">31</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># USDT in the pool after the swap = WETH_before * USDT_before / WETH_after</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">57</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">56</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># division for the above (= Y)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">31</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># WETH in the pool after the swap, for real = WETH_before + amountIn (= X)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># below here are computations to calculate the amount for the backrunning tx</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># note that the computations slightly diverges from the formula given before in order to minimize the error that comes from working on integers instead of floating point numbers</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">33</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">58</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR1 = PRECISION * X</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">35</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># PRICE * fee (*3 of the fee part)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">561</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># PRICE * fee (division for the above (/1000 for the fee part))</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">35</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">562</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># PRICE_FEES = PRICE - PRICE * fee</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">63</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">59</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR2 = PRICE_FEES * Y</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">34</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">33</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR3 = 2 * PRECISION</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">36</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR4 = 4 * VAR3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#   (VAR5) = VAR1 * FEE (*3 of the fee part)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">67</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR5 division for the above (/1000 for the fee part)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">66</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR6 = VAR1 * VAR4</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">68</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">68</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR5 * VAR5</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">69</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#   VAR6 * FEE (*3 of the fee part)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">71</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR6 * FEE division for the above (/1000 for the fee part)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">70</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">72</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR5 * VAR5 - VAR6 * FEE</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">73</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">69</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># above + VAR6</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">74</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># sqrt(). second operand is unused.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">75</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">68</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># sqrt() + VAR5</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">34</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 2 * VAR1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">76</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">77</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># sqrt() + VAR5 - 2 * VAR1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dividend done</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">65</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR3 * FEE (*3 of the fee part)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">79</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR3 * FEE division for the above (/1000 for the fee part)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">65</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># VAR3 - VAR3 * FEE (= divisor)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">78</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">81</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># amount = dividend / divisor</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># finished computing the amount for backrunning here</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># profit = (sell price - buy price) * amountOut / PRECISION - cost</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># amountIn now refers to the amount of the backrunning tx.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">82</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># amountIn * FEE (*3 of the fee part)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">83</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># amountIn * FEE (division for the above (/1000 for the fee part))</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">58</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">82</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># X + amountIn</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">85</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">84</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># X_after_fee = X + amountIn - amountIn * FEE</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">58</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">59</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># X * Y</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">87</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">86</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Y_after = X * Y / X_after_fee</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">59</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">88</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># amountOut = Y - Y_after</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">37</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">35</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># sell price - buy price</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">90</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">89</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># (sell price - buy price) * amountOut</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">91</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">33</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># (sell price - buy price) * amountOut / PRECISION</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">92</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">38</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># profit = (sell price - buy price) * amountOut / PRECISION - cost</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># profit done</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="perform-comparisons-to-validate-the-transaction"></a>Perform Comparisons to Validate the Transaction<a class="hash-link" href="#perform-comparisons-to-validate-the-transaction" title="Direct link to heading">#</a></h3><p>The searcher wants to ensure that the backrunning transaction is sent to the builder if and only if the user‚Äôs transaction indeed swaps of ETH for USDT on Uniswap v2 and the backrunning transaction is indeed profitable. To this end, the searcher performs comparisons in order to validate the user‚Äôs transaction as well as the results of the computation in the previous step of the MPC backrunning protocol. Note that this low-level representation only references storage locations and comparators. The comparator codes are 5 for less than, 6 for less than or equal, 7 for greater than, 8 for greater than or equal, 9 for equality, and 10 inequality.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><pre tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># to address == Uniswap V2 router</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># function selector/method id == swapExactETHForTokens(uint256,address[],address,uint256)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># path length == 2</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">26</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># token1 == WETH</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># token2 == USDT</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">28</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># deadline &gt;= minimum deadline</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">82</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">39</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># backrun amountIn &gt; 0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">93</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">39</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># backrun profit &gt; 0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="generating-the-backrunning-transaction"></a>Generating the Backrunning Transaction<a class="hash-link" href="#generating-the-backrunning-transaction" title="Direct link to heading">#</a></h3><p>The creation of the backrunning transaction only involves a list of references to the locations of protocol-internal storage items and encoding them using RLP. In this PoC, the searcher utilizes the same Uniswap v2 pool for the backrunning transaction, but calls the <code>swapExactTokensForETH</code> function instead of the <code>swapExactETHForTokens</code> used by the user. By inputting USDT, the searcher will receive ETH that can be sold for profit.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><pre tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">40</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># nonce</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">41</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># gas limit</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">42</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># gas price</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">23</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># to address. Uniswap v2 router</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">39</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># value. 0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">43</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># function selector/method id for swapExactTokensForETH(uint256,uint256,address[],address,uint256)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">82</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># amountIn</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">89</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># amountOutMin == amountOut</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">44</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># storage location</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">45</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># to address. recipient of the ETH</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">46</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># deadline</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># len of address[]/path</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># token1. USDT</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">26</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># token2. WETH</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="results-of-backrunning-the-swap"></a>Results of Backrunning the Swap<a class="hash-link" href="#results-of-backrunning-the-swap" title="Direct link to heading">#</a></h3><p>At block 16088213, the Uniswap v2 pool held approximately 11,866.58 WETH and 15,191,824.72 USDT. Our in-protocol computations were consistent with the on-chain state of the pool at block 16088214, which showed approximately 11,870.33 WETH and 15,187,039.81 USDT. The price of 1 WETH before the swap was around 1,280.22 USDT, while after the swap, it was around 1,279.41 USDT.</p><p>In this PoC, the searcher was willing to pay up to 1,283.5 USDT per WETH and purchased approximately 1.1008 WETH for approximately 1,412.70 USDT (at a price of about 1,283.38 USDT/WETH). The searcher also specified that they could sell ETH for at least 1,286.0 USDT on a CEX, with a 2.0 USDT cost (including the cost for the backrun).</p><p>Based in this information, the backrun generated a profit of at least 0.75 USDT. However, if the searcher had specified that they could only sell ETH at a lower price or that the cost of selling ETH plus the backrun would be higher, the backrun transaction would not have been profitable and therefore not have been generated.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="open-questions-and-future-work"></a>Open Questions and Future Work<a class="hash-link" href="#open-questions-and-future-work" title="Direct link to heading">#</a></h2><ul><li>Expressiveness of the searcher language: The searcher language&#x27;s current functionality can be extended by incorporating more operators such as modulo or shifting. Nevertheless, it is unknown if the language is indeed expressive enough to implement all the existing search strategies.</li><li>Improving the usability of the searcher language: The current searcher language is low-level and prone to errors. One way to address this is to create a high-level language that compiles to the low-level searcher language. The high-level language could include features such as variable names, operator names, comments, fixed-length loops, and the ability to perform multiple operations within a single expression. What could such a high-level language look like in detail, and what additional features could it offer? Would the support of branching in the computational step be useful?</li><li>Making the PoC practical: The current MPC backrunning protocol has excessive computational and communication overhead, rendering it impractical for real-world use. For example, in the strongest MPC security model, where two of the three parties can act arbitrarily malicious while retaining information secrecy, execution takes approximately 22.5 hours and requires 33.7 PB of data transfer across 9.6 million communication rounds. Even in the weaker security model used for testing, where two parties are assumed to be honest, and the third party attempts to extract as much information as possible without deviating from the protocol, execution still takes around 4 minutes and requires 6 GB of data transfer in 3.5 million communication rounds. While the focus of this PoC was to examine the trade-off between the expressiveness of the searcher‚Äôs program and potential covert channels‚Äînot performance optimization‚Äîthe critical question remains: how can the searcher language and the backrunning protocol be implemented practically for real-world use? Several possible solutions seem conceivable, such as implementing the searcher language and the backrunning protocol with SGX, transforming the three-party MPC setting into 2PC with garbled circuits, or using homomorphic encryption instead of, or in addition to, MPC. By exploring these options, our goal is to make the searcher language and the backrunning protocol more practical for real-world use.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>This article examines the user-searcher interface in the MEV transaction supply chain, focusing on the confidentiality of both the user&#x27;s transaction and the searcher&#x27;s strategy, while enabling searchers to perform backrun transactions. The use of SGX is discussed, and covert channels are identified as a threat to the confidentiality of the user&#x27;s transaction. We explore the balance between the expressiveness of the searcher&#x27;s program and the risk of information leakage through covert channels. To address this challenge, a backrun protocol and a covert channel-free searcher language are developed, using MPC. Finally, we demonstrate a proof-of-concept backrun implementation on a Uniswap trade.</p><p>With that, thanks for reading, and looking forward to <a href="https://collective.flashbots.net/t/backrunning-private-transactions/1198" target="_blank" rel="noopener noreferrer">your comments in the forum</a>! ‚ö°ü§ñ</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/block-building-inside-sgx"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">¬´ Block Building inside SGX</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/geth-inside-sgx"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Running Geth within SGX: Our Experience, Learnings and Code ¬ª</div></a></div></nav></main><div class="col col--2 TOC_BWJh"><div class="tableOfContents_H-s0 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a></li><li><a href="#sgx-based-backrunning-and-covert-channels" class="table-of-contents__link">SGX-Based Backrunning and Covert Channels</a></li><li><a href="#mpc-based-backrunning" class="table-of-contents__link">MPC-Based Backrunning</a></li><li><a href="#proof-of-concept-walk-through" class="table-of-contents__link">Proof-of-Concept Walk-Through</a><ul><li><a href="#decoding-the-transaction-with-rlp" class="table-of-contents__link">Decoding the Transaction with RLP</a></li><li><a href="#loading-constants" class="table-of-contents__link">Loading Constants</a></li><li><a href="#execute-computations" class="table-of-contents__link">Execute Computations</a></li><li><a href="#perform-comparisons-to-validate-the-transaction" class="table-of-contents__link">Perform Comparisons to Validate the Transaction</a></li><li><a href="#generating-the-backrunning-transaction" class="table-of-contents__link">Generating the Backrunning Transaction</a></li><li><a href="#results-of-backrunning-the-swap" class="table-of-contents__link">Results of Backrunning the Swap</a></li></ul></li><li><a href="#open-questions-and-future-work" class="table-of-contents__link">Open Questions and Future Work</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="col footer__links"><div><ul class="row footer__items"><li class="footer__item"><a href="https://github.com/flashbots" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li><li class="footer__item"><a href="https://docs.flashbots.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation</a></li><li class="footer__item"><a href="https://status.flashbots.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Status</a></li></ul></div><div><ul class="row footer__items"><li class="footer__item"><a href="https://calendar.flashbots.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Calendar</a></li><li class="footer__item"><a href="https://writings.flashbots.net/tags/transparency-report" target="_blank" rel="noopener noreferrer" class="footer__link-item">Transparency reports</a></li></ul></div><div><ul class="row footer__items"><li class="footer__item"><a href="http://discord.gg/flashbots" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCclbTgsnYUy3vmrptIqCmqQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">¬© 2023 Flashbots, Ltd</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a693e036.js"></script>
<script src="/assets/js/main.06935cd7.js"></script>
</body>
</html>