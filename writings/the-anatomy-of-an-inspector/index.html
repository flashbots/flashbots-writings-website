<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/writings/rss.xml" title="Flashbots Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/writings/atom.xml" title="Flashbots Blog Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/research/rss.xml" title="Flashbots Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/research/atom.xml" title="Flashbots Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><title data-react-helmet="true">How To Light Up The Dark Forest - A Walkthrough of Building A Cryptopunk MEV Inspector | Flashbots</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://writings.flashbots.net/writings/the-anatomy-of-an-inspector"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="How To Light Up The Dark Forest - A Walkthrough of Building A Cryptopunk MEV Inspector | Flashbots"><meta data-react-helmet="true" name="description" content="A step-by-step walkthrough of how to add a new MEV inspector using a recently added cryptopunk snipers inspector as an example."><meta data-react-helmet="true" property="og:description" content="A step-by-step walkthrough of how to add a new MEV inspector using a recently added cryptopunk snipers inspector as an example."><meta data-react-helmet="true" property="og:image" content="https://writings.flashbots.net/img/transparency-january-1.jpeg"><meta data-react-helmet="true" name="twitter:image" content="https://writings.flashbots.net/img/transparency-january-1.jpeg"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-12-15T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://twitter.com/bertcmiller"><meta data-react-helmet="true" property="article:tag" content="flashbots"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://writings.flashbots.net/writings/the-anatomy-of-an-inspector"><link data-react-helmet="true" rel="alternate" href="https://writings.flashbots.net/writings/the-anatomy-of-an-inspector" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://writings.flashbots.net/writings/the-anatomy-of-an-inspector" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.af4bf933.css">
<link rel="preload" href="/assets/js/runtime~main.0c9f46bc.js" as="script">
<link rel="preload" href="/assets/js/main.dbaf2e89.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navRoot_1Vd8 navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items fixFlex_19nV"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><svg width="12" height="14" viewBox="0 0 12 14"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.07289 0L7.91879 0.483459L6.631 4.76674H11.5178L4.19989 12.679L3.35398 12.1956L4.72089 7.64736H0L7.07289 0ZM5.20514 6.03608L6.33835 2.26697L2.28701 6.64736H5.02136L5.20514 6.03608ZM4.93407 10.4124L9.23077 5.76674H6.33078L6.16271 6.3243L4.93407 10.4124Z" fill="var(--ifm-font-color-base)"></path></svg><span class="navbar__title title_2fsg logoTitle_2plQ">Flashbots</span></a></div><div class="navbar__items navbar__items--right fixFlex_19nV navItems_l2fJ"><a href="https://flashbots.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>About</span></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/writings">Writings</a><a class="navbar__item navbar__link" href="/research">Research</a><div class="react-toggle toggle_268h react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page layoutDefaults_1s0t"><div class="container margin-vert--md containerRoot_3RmU"><div class="row"><main class="col col--12" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_nmLu" itemprop="headline">How To Light Up The Dark Forest - A Walkthrough of Building A Cryptopunk MEV Inspector</h1><div class="blogPostData_3WzT margin-vert--md"><time datetime="2021-12-15T00:00:00.000Z" itemprop="datePublished">15.12.21</time> ¬∑ 11 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_HqTB"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/bertcmiller" target="_blank" rel="noopener noreferrer" class="fixedColor_3yYP" itemprop="url"><span itemprop="name">Robert Miller</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://writings.flashbots.net/img/transparency-january-1.jpeg"><div class="markdown" itemprop="articleBody"><p>A step-by-step walkthrough of how to add a new MEV inspector using a recently added cryptopunk snipers inspector as an example.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="punk-snipers-and-mev-inspect-py"></a>Punk snipers and mev-inspect-py<a class="hash-link" href="#punk-snipers-and-mev-inspect-py" title="Direct link to heading">#</a></h2><p>Last month I was pinged on Twitter about a novel form of MEV involving cryptopunks, one of the first and most valuable NFTs. Cryptopunks, or punks, were designed with their own native marketplace in the contract. You can list your punk, bid on other punks, and accept bids from the cryptopunk smart contract itself.</p><p>However, the design of this marketplace left open an area for frontrunning bots! When a punk owner accepted an offer to sell their punk they were actually accepting the highest existing offer on the market. If someone offered to buy a punk at a very low price and the punk owner accepted that offer, then MEV bots would race in front of the punk owner‚Äôs acceptance with an offer that was just barely higher than the original low priced offer. As a result the MEV bot‚Äôs offer would be the highest when the owner‚Äôs acceptance was executed, and the MEV bot would receive the punk at a great price.</p><p>By doing so these sniper bots were able to systematically buy cryptopunks at low prices at the expense of the users who had originally placed low bids! The punk community was upset because the buyers who worked to find and attempted buy punks at low prices weren‚Äôt being rewarded ‚Äì bots were.</p><p>With this in mind I turned to mev-inspect (‚ÄúInspect‚Äù) to try to shine a bright light on what was going on in the underbelly of the punk market. Inspect is Flashbots‚Äô open source tool to inspect historical Ethereum blocks for MEV extraction, and the data pipeline underlying MEV-explore. Inspect attempts to classify MEV extraction by strategy and to surface relevant data for analysis. For example, it can spot arbitrage between a number of top DEXes as well as liquidations. It is the perfect tool to analyze new MEV strategies.</p><p>Inspect had gone through a few iterations since I had last contributed. It was now 10x more professional with 10x the features because of the great work by my colleagues Taarush, Gui, and Luke. As a team we felt that the codebase was ready for more contributions, and I was excited to try to do that by adding a new inspector for this punks use case.</p><p>The cryptopunk snipe inspector is now live and in production. This blog post documents the process of writing a new inspector and uses the cryptopunk snipe inspector as a reference. I hope it serves as a motivation and guide for others to contribute to Inspect. A follow on blog post will focus on the data surrounding cryptopunk sniping MEV.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="building-with-mev-inspect-py"></a>Building with mev-inspect-py<a class="hash-link" href="#building-with-mev-inspect-py" title="Direct link to heading">#</a></h2><p>At a high level inspect works by getting all of the traces for a transaction, classifying traces, building schemas, inferring MEV strategies, and finally posting data to a database. At the end of this process inspect will have populated a database with structured data about the mev strategies it found.</p><p>To add a new MEV strategy, the cryptopunk sniping, to Inspect I took the following steps:</p><ul><li>Add the cryptopunk ABI to our list of ABIs <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/abis/cryptopunks/cryptopunks.json" target="_blank" rel="noopener noreferrer">(link)</a></li><li>List classifications for the actions we want under the trace schema <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/schemas/traces.py#L34-L35" target="_blank" rel="noopener noreferrer">(link)</a> as well as a cryptopunk entry in the protocols <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/schemas/traces.py#L49" target="_blank" rel="noopener noreferrer">(link)</a></li><li>Create a punk classifier spec <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/classifiers/specs/cryptopunks.py#L17" target="_blank" rel="noopener noreferrer">(link)</a></li><li>Build schemas with the data we want <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/schemas/punk_snipe.py" target="_blank" rel="noopener noreferrer">(link)</a></li><li>Parse the traces into our new punk schemas <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/punks.py" target="_blank" rel="noopener noreferrer">(link)</a></li><li>Add database models <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/models/punks.py" target="_blank" rel="noopener noreferrer">(link)</a> and crud functions <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/crud/punks.py" target="_blank" rel="noopener noreferrer">(link)</a></li><li>Add Alembic files for database migrations <a href="https://github.com/flashbots/mev-inspect-py/blob/main/alembic/versions/52d75a7e0533_add_punk_bid_acceptances.py" target="_blank" rel="noopener noreferrer">(link)</a></li></ul><p>Here I implemented a new strategy inspector, which required all 7 steps. <strong>But if you‚Äôre adding a new protocol (e.g. a DEX) to an existing inspector (e.g. arbitrage), then only the first 3 steps are necessary because steps 4 to 7 have already been completed. New specs will fit into existing schemas, parsing scripts, and database integrations.</strong></p><p>Regardless, let‚Äôs look at each of these 7 steps in detail. This process is only loosely linear and looks more intimidating than it is. Some steps are performed in parallel and you may revisit some steps as you design your objects.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="add-the-cryptopunk-abi"></a>Add the cryptopunk ABI<a class="hash-link" href="#add-the-cryptopunk-abi" title="Direct link to heading">#</a></h3><p>To identify a contract and its functions Inspect needs its ABI. With a quick Google search I found the <a href="https://etherscan.io/address/0xb47e3cd837ddf8e4c57f05d70ab865de6e193bbb#code" target="_blank" rel="noopener noreferrer">CryptoPunks contract address on Etherscan</a> and grabbed the abi by clicking ‚Äúcontract,‚Äù scrolling down, and copy/pasting the ABI into a new file. That file was named <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/abis/cryptopunks/cryptopunks.json" target="_blank" rel="noopener noreferrer">‚Äúcryptopunks.json</a>‚Äù and placed in a ‚Äú<a href="https://github.com/flashbots/mev-inspect-py/tree/main/mev_inspect/abis/cryptopunks" target="_blank" rel="noopener noreferrer">cryptopunks</a>‚Äù folder inside the <a href="https://github.com/flashbots/mev-inspect-py/tree/main/mev_inspect/abis" target="_blank" rel="noopener noreferrer">ABI folder</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="creating-classification-and-protocol-entries"></a>Creating Classification and Protocol entries<a class="hash-link" href="#creating-classification-and-protocol-entries" title="Direct link to heading">#</a></h3><p>(This blog post assumes some knowledge of traces. Please review <a href="https://medium.com/@theimperialduke/ethereum-traces-not-transactions-3f0533d26aa" target="_blank" rel="noopener noreferrer">this blog post</a> if you need an intro.)</p><p>For a given trace Inspect will attempt to classify it by checking:</p><ul><li>What address is this trace interacting with?</li><li>Does that address have an ABI that Inspect knows about?</li><li>Is the trace calling a function we care about?</li></ul><p>Thus far we have only given Inspect an ABI, but soon we‚Äôll write a specification that tells Inspect what addresses and functions to look for. Whenever it finds that address and function combination in a trace it will classify that trace with a label that you give it. This step is about creating those labels.</p><p>Given we are classifying traces, we add a classification to the <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/schemas/traces.py#L34-L35" target="_blank" rel="noopener noreferrer">traces.py schema</a>. This is as easy as listing a short description of the things we want to classify, in this case, punk bids (punk_bid) and punk bid acceptances (punk_accept_bid).</p><p>We also add an entry under ‚ÄúProtocol‚Äù for the protocol we‚Äôre working on if it doesn‚Äôt already exist. Again, we add ‚Äú<a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/schemas/traces.py#L49" target="_blank" rel="noopener noreferrer">cryptopunks</a>‚Äù to the list of protocols.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="create-a-punk-classifier-spec"></a>Create a punk classifier spec<a class="hash-link" href="#create-a-punk-classifier-spec" title="Direct link to heading">#</a></h3><p>A classifier spec builds on the Classification and Protocol entries we just made by telling Inspect what to look for in classifying traces. For the cryptopunk sniper it looked like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> mev_inspect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schemas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">traces </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Protocol</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Classification</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> mev_inspect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schemas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">classifiers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassifierSpec</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Classifier</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PunkBidAcceptanceClassifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Classifier</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@staticmethod</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_classification</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Classification</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Classification</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">punk_accept_bid</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PunkBidClassifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Classifier</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@staticmethod</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_classification</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Classification</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Classification</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">punk_bid</span></span><span class="token-line" style="color:#393A34"><span class="token plain">CRYPTO_PUNKS_SPEC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ClassifierSpec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    abi_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cryptopunks&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Protocol</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cryptopunks</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    valid_contract_addresses</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;0xb47e3cd837dDF8e4c57F05d70Ab865de6e193BBB&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    classifiers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;enterBidForPunk(uint256)&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PunkBidClassifier</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;acceptBidForPunk(uint256,uint256)&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PunkBidAcceptanceClassifier</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">CRYPTOPUNKS_CLASSIFIER_SPECS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CRYPTO_PUNKS_SPEC</span><span class="token punctuation" style="color:#393A34">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Let‚Äôs work through this. First, we create classes for the classifiers of the action that we are interested in. In our case we want to classify punk bids and acceptances, so we create PunkBidAcceptanceClassifier and PunkBidClassifier.</p><p>Inspect asks you to be specific about how these classifiers are used. The reason for this is that we want to be able to identify some types of actions across many protocols, but not all protocols are designed in the same way. For example, the function to swap assets is different across many DEXes, so in order to build a single ‚Äúswap‚Äù classification, we need to tell Inspect what to do for each protocol you want to classify swaps on.</p><p>For one-off protocols, like my punk inspector, you can copy the template that I used and replace the punk-specific parts. But if you are adding support for a protocol to classify an action that isn‚Äôt standardized across the ecosystem I‚Äôd suggest looking at how Swaps are implemented across a few DEXes.</p><p>Below these standardized functions are the spec itself. The spec has 4 parts:</p><ul><li><em>abi_name</em>: the name of the abi entered earlier. Must match exactly the filename you specified.</li><li><em>protocol</em>: the protocol specified in the previous step.</li><li><em>valid_contract_addresses</em>: any contract addresses that you want to look for. Note that this can be omitted in the case that you don‚Äôt want to limit a classifier to a set of addresses.</li><li><em>classifiers</em>: a list of functions that you want to look for along with their classifications. For example, we want to look for punk bids, so we create an entry for the ‚ÄúPunkBidClassifier‚Äù for the function ‚ÄúenterBidForPunk(uint256).‚Äù Note that classifiers work through the usage of <a href="https://solidity-by-example.org/function-selector/" target="_blank" rel="noopener noreferrer">function selectors</a>, so you must specify the function name and its types with no spaces.</li></ul><p>Lastly, you must add the classifier spec to the <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/classifiers/specs/__init__.py" target="_blank" rel="noopener noreferrer">init.py</a> file to make it visible to Inspect. At this point, Inspect will start to classify traces associated with your protocol üéâ!</p><p>After running inspect on blocks that contain the MEV you are looking for you can <a href="https://github.com/flashbots/mev-inspect-py#exploring" target="_blank" rel="noopener noreferrer">view the output of Inspect by pulling up the database</a> and querying the ‚Äúclassified_traces‚Äù table for your ABI. If you are adding support for a new protocol (e.g. a dex) to an existing inspector (e.g. arbs) then your work would be finished at this stage!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="build-schemas-with-the-data-we-want"></a>Build schemas with the data we want<a class="hash-link" href="#build-schemas-with-the-data-we-want" title="Direct link to heading">#</a></h3><p>Inspect works by building structured objects we call schemas. Each schema is stored in a separate file in the <a href="https://github.com/flashbots/mev-inspect-py/tree/main/mev_inspect/schemas" target="_blank" rel="noopener noreferrer">schemas folder</a> and is built to store data about some object. They look like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PunkBid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    block_number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    transaction_hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    trace_address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    punk_index</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You will need to make a schema for each new object you‚Äôd like to create. In my case, I created three: punk bids, punk bid acceptances, and punk snipes. In making a schema think about the information that you and others will want to see.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="parse-the-traces-into-our-new-schemas"></a>Parse the traces into our new schemas<a class="hash-link" href="#parse-the-traces-into-our-new-schemas" title="Direct link to heading">#</a></h3><p>With traces being classified for the actions we want we can start to query for our classifications and write the logic of our strategy inspector. The way to do this is simple. As an example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">classification </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Classification</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">punk_bid</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            punk_bid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PunkBid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                transaction_hash</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transaction_hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                block_number</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">block_number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                trace_address</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trace_address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                from_address</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                punk_index</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inputs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;punkIndex&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                price</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> punk_bid</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For every new strategy inspector, we create a file in the <a href="https://github.com/flashbots/mev-inspect-py/tree/main/mev_inspect" target="_blank" rel="noopener noreferrer">mev_inspect folder</a> and reference it in <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/inspect_block.py" target="_blank" rel="noopener noreferrer">inspect_block.py</a>, the heart of Inspect. The function you are calling should take in a list of classified traces and return a schema.</p><p>In the case of punk bids and acceptances, we need little logic to build our schemas. However, the use case of identifying punk snipes requires some logic and a list of both bids and acceptances. We first get bids and acceptances, then use these as inputs to a <a href="https://github.com/flashbots/mev-inspect-py/blob/9ffa9d2df9474924391058427d9feddde504ac02/mev_inspect/punks.py#L29-L55" target="_blank" rel="noopener noreferrer">function that checks for snipes</a>, and returns a list of snipes if any existed.</p><p>At this point I‚Äôll add a few prints in my code to make and turn a test run to make sure everything is working as intended. You can run a test with the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mev inspect </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BLOCK_NUMBER</span><span class="token punctuation" style="color:#393A34">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="add-database-models-and-crud-functions"></a>Add database models and crud functions<a class="hash-link" href="#add-database-models-and-crud-functions" title="Direct link to heading">#</a></h3><p>Now almost all of the logic of your inspector has been completed. What remains is to post the data you‚Äôve generated to databases for easy querying and viewing. To do this we need to create models of what our database entry should look like, and crud functions to write/delete from the database.</p><p>Database models specify the data you want to be stored and what data types each entry should be. Here‚Äôs what the punk snipe entry looks like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PunkSnipeModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Base</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    __tablename__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;punk_snipes&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    block_number </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Column</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Numeric</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nullable</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    transaction_hash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Column</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> primary_key</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    trace_address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Column</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ARRAY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Integer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> primary_key</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Column</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nullable</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    punk_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Column</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Integer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nullable</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_acceptance_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Column</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Numeric</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nullable</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    acceptance_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Column</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Numeric</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nullable</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You should create a unique file and store it in the <a href="https://github.com/flashbots/mev-inspect-py/tree/main/mev_inspect/models" target="_blank" rel="noopener noreferrer">models folder</a>.
Crud functions are stored in <a href="https://github.com/flashbots/mev-inspect-py/tree/main/mev_inspect/crud" target="_blank" rel="noopener noreferrer">the crud folder</a>. These use our schemas and database models to write and delete from the Inspect database. I suggest you read the <a href="https://github.com/flashbots/mev-inspect-py/blob/main/mev_inspect/crud/punks.py" target="_blank" rel="noopener noreferrer">punk crud</a> as an example and use it as a template to create your own by replacing the schema and models.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="add-alembic-files-for-database-migrations"></a>Add Alembic files for database migrations<a class="hash-link" href="#add-alembic-files-for-database-migrations" title="Direct link to heading">#</a></h3><p>Alembic is a lightweight database migration tool. We use it to manage different revisions to the inspect database. Given you‚Äôre adding a new inspector you‚Äôll need to make changes to the databases.</p><p>To spin up a new alembic revision file use the following command:
<code>./mev exec alembic revision ‚Äîautogenerate -m ‚Äú{message}‚Äù</code>
Then copy it out of your kubernetes pod into your local machine with:
<code>kubectl cp pod:dir/file local_dir/file</code>
Now edit this file and add the features of the database that you want. This should closely resemble the model that you created in the last step. The alembic file for the punk snipe database entry is a nice example. Finally, upgrade your database with the new migration with:
<code>./mev exec alembic upgrade head</code></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="putting-it-all-together"></a>Putting it all together<a class="hash-link" href="#putting-it-all-together" title="Direct link to heading">#</a></h3><p>Now you are ready to inspect a block and query the database for results. First we run Inspect over a block:
<code>./mev inspect [BLOCK_NUMBER]</code>
Now we connect to the local postgres database:
<code>./mev db</code>
You should see <code>mev_inspect=#</code>. In my case I wanted to check out my new punk tables, so I ran
<code>SELECT COUNT(*) FROM punk_snipes;</code>
Which returned 1! That means Inspect is successfully finding punk snipes.</p><p>Congratulations! You‚Äôve learned about the different moving parts involved in creating a new MEV inspector. I hope you‚Äôll give writing one yourself a shot, and don‚Äôt be afraid to jump in the Flashbots Discord to ask questions in #mev-inspect. We have a list of current and desired classifiers on the Inspect repo if you suggestions for where to start. Come illuminate the dark forest with us, anon!</p><p>Thank you to Taarush, Chris, Gui, Luke, and Alex for reviewing this article.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/writings/transparency-21q4"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">¬´ Flashbots Transparency Report ‚Äî Sept-Dec 2021</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/writings/on-the-most-profitable-block"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Why Building the Most Profitable Block is Important ¬ª</div></a></div></nav></main><div class="col col--2 TOC_1KIS"><div class="tableOfContents_rbnR thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#punk-snipers-and-mev-inspect-py" class="table-of-contents__link">Punk snipers and mev-inspect-py</a></li><li><a href="#building-with-mev-inspect-py" class="table-of-contents__link">Building with mev-inspect-py</a><ul><li><a href="#add-the-cryptopunk-abi" class="table-of-contents__link">Add the cryptopunk ABI</a></li><li><a href="#creating-classification-and-protocol-entries" class="table-of-contents__link">Creating Classification and Protocol entries</a></li><li><a href="#create-a-punk-classifier-spec" class="table-of-contents__link">Create a punk classifier spec</a></li><li><a href="#build-schemas-with-the-data-we-want" class="table-of-contents__link">Build schemas with the data we want</a></li><li><a href="#parse-the-traces-into-our-new-schemas" class="table-of-contents__link">Parse the traces into our new schemas</a></li><li><a href="#add-database-models-and-crud-functions" class="table-of-contents__link">Add database models and crud functions</a></li><li><a href="#add-alembic-files-for-database-migrations" class="table-of-contents__link">Add Alembic files for database migrations</a></li><li><a href="#putting-it-all-together" class="table-of-contents__link">Putting it all together</a></li></ul></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Flashbots ¬© 2022</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0c9f46bc.js"></script>
<script src="/assets/js/main.dbaf2e89.js"></script>
</body>
</html>