<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Flashbots Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Flashbots Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><title data-react-helmet="true">Running Geth within SGX: Our Experience, Learnings and Code | Flashbots</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://writings.flashbots.net/geth-inside-sgx"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Running Geth within SGX: Our Experience, Learnings and Code | Flashbots"><meta data-react-helmet="true" name="description" content="We are happy to publish our efforts and a number of key learnings about running Geth inside SGX, for others to reuse, experiment with, and build upon."><meta data-react-helmet="true" property="og:description" content="We are happy to publish our efforts and a number of key learnings about running Geth inside SGX, for others to reuse, experiment with, and build upon."><meta data-react-helmet="true" property="og:image" content="https://writings.flashbots.net/img/posts/sgx-og.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://writings.flashbots.net/img/posts/sgx-og.jpg"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-12-20T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://twitter.com/metachris/"><meta data-react-helmet="true" property="article:tag" content="privacy,sgx"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://writings.flashbots.net/geth-inside-sgx"><link data-react-helmet="true" rel="alternate" href="https://writings.flashbots.net/geth-inside-sgx" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://writings.flashbots.net/geth-inside-sgx" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.1b11a3d0.css">
<link rel="preload" href="/assets/js/runtime~main.677221ba.js" as="script">
<link rel="preload" href="/assets/js/main.15395b8e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navRoot_1Vd8 navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items fixFlex_19nV"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><svg width="12" height="14" viewBox="0 0 12 14"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.07289 0L7.91879 0.483459L6.631 4.76674H11.5178L4.19989 12.679L3.35398 12.1956L4.72089 7.64736H0L7.07289 0ZM5.20514 6.03608L6.33835 2.26697L2.28701 6.64736H5.02136L5.20514 6.03608ZM4.93407 10.4124L9.23077 5.76674H6.33078L6.16271 6.3243L4.93407 10.4124Z" fill="var(--ifm-font-color-base)"></path></svg><span class="navbar__title title_2fsg logoTitle_2plQ">Flashbots</span></a></div><div class="navbar__items navbar__items--right fixFlex_19nV navItems_l2fJ"><a href="https://flashbots.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>About</span></a><a href="https://boost.flashbots.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>MEV-Boost</span></a><a href="https://collective.flashbots.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Forum</span></a><a href="https://jobs.flashbots.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Join us</span></a><div class="react-toggle toggle_268h react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page layoutDefaults_1s0t"><div class="container margin-vert--md containerRoot_3RmU"><div class="row"><main class="col col--12" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_nmLu" itemprop="headline">Running Geth within SGX: Our Experience, Learnings and Code</h1><div class="blogPostData_3WzT margin-vert--md"><time datetime="2022-12-20T00:00:00.000Z" itemprop="datePublished">20.12.22</time> · 5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_HqTB"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/metachris/" target="_blank" rel="noopener noreferrer" class="fixedColor_3yYP" itemprop="url"><span itemprop="name">Chris Hager</span></a></div></div></div></div><div class="col col--6 authorCol_HqTB"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a class="fixedColor_3yYP" itemprop="url"><span itemprop="name">Frieder Paape</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://writings.flashbots.net/img/posts/sgx-og.jpg"><div class="markdown" itemprop="articleBody"><p>At Flashbots, we are exploring trusted execution environments (TEEs) such as SGX, as well as other privacy technologies such as Multi-Party Computation and Homomorphic Encryption, as important building blocks for trustless collaboration along the transaction supply chain. This is particularly relevant for applications such as decentralized block building and sharing private orderflow.</p><p>Today we are happy to publish our efforts and a number of key learnings about running Geth inside SGX, for others to reuse, experiment with, and build upon.</p><p><img alt="Suave Logo" src="/assets/images/sgx-og-394762d1adb298eeb510c940cedfe678.jpg"></p><p>In collaboration with <a href="https://konvera.io" target="_blank" rel="noopener noreferrer">konVera</a>, a software development company with strong expertise in confidential computing, we have achieved a fully working prototype of Geth running inside SGX and syncing with Ethereum mainnet.</p><p>You can find the code at <a href="https://github.com/flashbots/geth-sgx-gramine" target="_blank" rel="noopener noreferrer">https://github.com/flashbots/geth-sgx-gramine</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="working-with-sgx"></a>Working with SGX<a class="hash-link" href="#working-with-sgx" title="Direct link to heading">#</a></h2><p>Historically the idea of TEEs such as SGX was to isolate only a small critical part of your application within the confinements of an enclave. For this, it is necessary to adapt the code to make it SGX aware. Only later on did people want to use SGX and run existing applications in isolation and do so without modification of the source code.</p><p>For this, libOSes such as <a href="https://gramineproject.io/" target="_blank" rel="noopener noreferrer">Gramine</a>,  <a href="https://occlum.io/" target="_blank" rel="noopener noreferrer">Occlum</a> and <a href="https://github.com/edgelesssys/ego" target="_blank" rel="noopener noreferrer">EGo</a> have been developed, to provide an abstraction layer to applications which expect to be run in Linux-like environments. We chose Gramine because it is the most mature and stable, and is well documented.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="issues-and-challenges"></a>Issues and Challenges<a class="hash-link" href="#issues-and-challenges" title="Direct link to heading">#</a></h2><p>As we began this process, we encountered several challenges and issues that we had to address.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="storing-the-state"></a>Storing the State<a class="hash-link" href="#storing-the-state" title="Direct link to heading">#</a></h3><p>One major problem we faced was the slow performance of Gramine’s encrypted file mounts, which made it difficult for Geth to keep up with Ethereum mainnet. This is likely a bug and should be investigated at some point.</p><p>To address this, we experimented with using different libOS frameworks, but ultimately found that these alternatives were not suitable for our needs:</p><ul><li>Occlum: performance was promising but it was highly unstable and we couldn’t get Geth running with encrypted state (many syscalls missing, unstable, lack of documentation).</li><li>EGo: easy to setup, but much slower than Gramine and did not support encrypted files at all.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="initial-sync"></a>Initial Sync<a class="hash-link" href="#initial-sync" title="Direct link to heading">#</a></h3><p>The initial sync process of the chain can take quite a long time, and currently requires up to 800GB of storage.</p><p>We chose to copy the unencrypted database from the host into SGX, rather than run the sync within SGX. Copying the database on startup
also encrypts the data, which takes about 3 hours because of the data size and cryptographic operations.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="information-leakage"></a>Information Leakage<a class="hash-link" href="#information-leakage" title="Direct link to heading">#</a></h3><p>Another issue we explored was the problem of information leakage, which occurs when the host system can extract information about what data is being accessed within the SGX enclave. In the case of Geth, this could potentially leak information about the keys being accessed from the database due to IO and memory access patterns.</p><p>This research paper explores the issue of IO leakage in more detail: “<em><a href="https://petsymposium.org/popets/2021/popets-2021-0002.pdf" target="_blank" rel="noopener noreferrer">SGX-MR: Regulating Dataflows for Protecting Access Patterns of Data-Intensive SGX Applications</a></em>” (Alam, Sharma, Chen, 2021)</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="in-memory-approach"></a>In-Memory Approach<a class="hash-link" href="#in-memory-approach" title="Direct link to heading">#</a></h2><p>In light of these challenges, we decided to try a different approach: storing the entire Geth database in memory and using encrypted swap space to make the approach less resource intensive.</p><p>To store the entire chain in-memory, we would need a system with at least 1TB of memory, which is hardware resource intensive and expensive. Another downside of this approach is that there is no persistence, and the state is lost if the Geth application stops.</p><p>Luckily, not all of the 1TB need to be accessed by the application at once, a lot of it can be encrypted by the SGX kernel driver and swapped out.</p><p>Our initial attempt was to run geth on a 384GB machine with 256GB EPC (SGX protected) memory and 1TB swap, and it worked well (~150 mgasps [million gas per second]). But those machines are costly and hard to come by (Azure only).</p><p>We found a trick though: you can use a server with large regular memory and treat it as buffer space. We ended up running on a machine with 500 GBs RAM, 1TB of SSD swap and 64 GBs of protected memory, which are much cheaper and more widely available. It performed at around 130 mgasps which is good enough.</p><p>While this approach does have some limitations, we have found it to be a viable option for running Geth within SGX.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>Running Geth within SGX is entirely possible, but both a resource- and time-consuming process. It needs a large amount of memory, has a startup time of around 3 hours, and state is easily lost.</p><p>While storing the database in memory and using encrypted swap space provides good performance, it may still be vulnerable to certain types of information leakage. On the other hand, using encrypted file systems within SGX may be the straight forward, less resource intensive way, but it can introduce performance issues and information leakage is even harder to avoid.</p><p>Ultimately, it is important to carefully assess the needs of your specific application and choose the solution that best meets those needs.</p><p>By publishing our code and learnings, we hope to provide a reference implementation and to stimulate broader exploration and collaboration!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="future-work"></a>Future work<a class="hash-link" href="#future-work" title="Direct link to heading">#</a></h2><ul><li>Reproducible builds (enable trust into which code is running in SGX)</li><li>Add <code>flock</code> system call to Gramine</li><li>Explore slowness of Gramine encrypted FS mounts</li><li>Explore possible IO leakage and implications</li><li>Verify attestations on-chain</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="thanks"></a>Thanks<a class="hash-link" href="#thanks" title="Direct link to heading">#</a></h2><p>Special shoutout to <a href="https://twitter.com/mmrosum" target="_blank" rel="noopener noreferrer">Mateusz Morusiewicz</a> and <a href="https://twitter.com/tkstanczak" target="_blank" rel="noopener noreferrer">Tomasz K. Stańczak</a> for their support and creativity in making this happen and solving a bunch of problems along the way.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="references"></a>References<a class="hash-link" href="#references" title="Direct link to heading">#</a></h2><p>You can find our code for running Geth inside SGX at <a href="https://github.com/flashbots/geth-sgx-gramine" target="_blank" rel="noopener noreferrer">github.com/flashbots/geth-sgx-gramine</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/the-future-of-mev-is-suave"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">The Future of MEV is SUAVE »</div></a></div></nav></main><div class="col col--2 TOC_1KIS"><div class="tableOfContents_rbnR thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#working-with-sgx" class="table-of-contents__link">Working with SGX</a></li><li><a href="#issues-and-challenges" class="table-of-contents__link">Issues and Challenges</a><ul><li><a href="#storing-the-state" class="table-of-contents__link">Storing the State</a></li><li><a href="#initial-sync" class="table-of-contents__link">Initial Sync</a></li><li><a href="#information-leakage" class="table-of-contents__link">Information Leakage</a></li></ul></li><li><a href="#in-memory-approach" class="table-of-contents__link">In-Memory Approach</a></li><li><a href="#summary" class="table-of-contents__link">Summary</a></li><li><a href="#future-work" class="table-of-contents__link">Future work</a></li><li><a href="#thanks" class="table-of-contents__link">Thanks</a></li><li><a href="#references" class="table-of-contents__link">References</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="col footer__links"><div><ul class="row footer__items"><li class="footer__item"><a href="https://github.com/flashbots" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li><li class="footer__item"><a href="https://docs.flashbots.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation</a></li><li class="footer__item"><a href="https://status.flashbots.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Status</a></li></ul></div><div><ul class="row footer__items"><li class="footer__item"><a href="https://calendar.flashbots.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Calendar</a></li><li class="footer__item"><a href="https://writings.flashbots.net/tags/transparency-report" target="_blank" rel="noopener noreferrer" class="footer__link-item">Transparency reports</a></li></ul></div><div><ul class="row footer__items"><li class="footer__item"><a href="http://discord.gg/flashbots" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCclbTgsnYUy3vmrptIqCmqQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2022 Flashbots, Ltd</div></div></div></footer></div>
<script src="/assets/js/runtime~main.677221ba.js"></script>
<script src="/assets/js/main.15395b8e.js"></script>
</body>
</html>